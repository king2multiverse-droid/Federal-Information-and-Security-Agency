<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Federal Information & Security Agency</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

<style>
body {
  background: black;
  color: #2f275e;
  font-family: Montserrat, monospace;
  margin: 0;
  padding: 10px;
}

#logo-container {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 0;
  pointer-events: none;
}

#logo {
  max-width: 320px;
  opacity: 0.15;
  filter: blur(2.5px);
}

#terminal {
  position: relative;
  z-index: 1;
  white-space: pre-wrap;
}

#input {
  display: inline;
}

#cursor {
  display: inline-block;
  width: 0.65em;
  margin-left: 1px;
  color: #2f275e;
  animation: cursorBlink 1.1s steps(1) infinite;
}

@keyframes cursorBlink {
  0% { opacity: 1; }
  50% { opacity: 0; }
  100% { opacity: 0; }
}
</style>
</head>

<body>

<div id="logo-container">
  <img src="FISA.png" alt="FISA Logo" id="logo">
</div>

<pre id="terminal"></pre>
<span>&gt; </span><span id="input"></span><span id="cursor">â–ˆ</span>

<textarea id="clipboard" style="position:fixed;opacity:0;height:1px;width:1px;"></textarea>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJDDsj4Ow8o-sbN3mPIb2sPn76ubIe-rNvKMZoEhBric-yId1yGHDQKThvXelrZag/exec";

let terminalState = "AUTH"; // AUTH | MAIN_MENU | SECTOR
const terminal = document.getElementById("terminal");
const inputSpan = document.getElementById("input");
const clipboard = document.getElementById("clipboard");

let buffer = "";

// ===============================
// STUTTER PRINT ENGINE
// ===============================
let printQueue = [];
let printing = false;

function stutterPrint(text) {
  printQueue.push(text);
  if (!printing) processQueue();
}

function processQueue() {
  if (printQueue.length === 0) {
    printing = false;
    return;
  }

  printing = true;
  const text = printQueue.shift();
  let i = 0;

  function typeChar() {
    if (i >= text.length) {
      setTimeout(processQueue, randomBetween(80, 180));
      return;
    }

    terminal.textContent += text[i++];
    let delay = randomBetween(12, 35);
    if (Math.random() < 0.03) delay += randomBetween(80, 160);
    setTimeout(typeChar, delay);
  }

  typeChar();
}

function randomBetween(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function print(text = "") {
  stutterPrint(text + "\n");
}

// ===============================
// INITIAL NOTICE
// ===============================
print(`
************************************************************
*                  FEDERAL SECURITY NOTICE                 *
************************************************************

THIS TERMINAL IS THE PROPERTY OF A FEDERAL AUTHORITY.

UNAUTHORIZED ACCESS OR USE IS STRICTLY PROHIBITED.

ENTER AUTHORIZATION CODE TO CONTINUE.
`);

function enterMainTerminal() {
  terminalState = "MAIN_MENU";
  stutterPrint("\nACCESS GRANTED\nCLEARANCE ACCEPTED\n\n");
  showMainMenu();
}

function showMainMenu() {
  stutterPrint(
`==================================================
        FEDERAL INFORMATION TERMINAL
==================================================

SELECT SECTOR:

1] FEDERATION COUNCIL
2] FEDERAL OPERATIONS
3] AGENT REGISTRY
4] MINISTERIAL OVERSIGHT
5] PROJECT 'IRON'
6] THE EYE

ENTER SECTOR NUMBER:
`
  );
}

// =======================
// INPUT HANDLING
// =======================
document.body.addEventListener("click", () => clipboard.focus());
clipboard.focus();

document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "v") return;

  if (e.key === "Backspace") {
    buffer = buffer.slice(0, -1);
    updateInput();
    e.preventDefault();
    return;
  }

  if (e.key === "Enter") {
    processCommand(buffer.trim());
    buffer = "";
    updateInput();
    e.preventDefault();
    return;
  }

  if (e.key.length === 1 && !e.ctrlKey) {
    buffer += e.key;
    updateInput();
    e.preventDefault();
  }
});

clipboard.addEventListener("paste", e => {
  buffer += e.clipboardData.getData("text").replace(/\s+/g, "");
  updateInput();
});

function updateInput() {
  inputSpan.textContent = buffer;
}

// =======================
// COMMAND HANDLER (FIXED)
// =======================
function processCommand(cmd) {
  terminal.textContent += "\n> " + cmd + "\n";
  if (!cmd) return;

  if (terminalState === "AUTH") {
    stutterPrint("VALIDATING TOKEN...\n");

    fetch(SCRIPT_URL + "?token=" + encodeURIComponent(cmd))
      .then(r => r.json())
      .then(res => {
        if (!res.ok) {
          stutterPrint("SECURITY VALIDATION FAILED\nSESSION TERMINATED\n");
          return;
        }
        enterMainTerminal();
      })
      .catch(() => stutterPrint("COMMUNICATION FAILURE\n"));

    return;
  }

  if (terminalState === "MAIN_MENU") {
    handleMainMenu(cmd);
    return;
  }
}

function handleMainMenu(cmd) {
  switch (cmd) {
    case "1": stutterPrint("\nACCESSING FEDERATION COUNCIL...\n"); break;
    case "2": stutterPrint("\nACCESSING FEDERAL OPERATIONS...\n"); break;
    case "3": stutterPrint("\nACCESSING AGENT REGISTRY...\n"); break;
    case "4": stutterPrint("\nACCESSING MINISTERIAL OVERSIGHT...\n"); break;
    case "5": stutterPrint("\nACCESSING PROJECT 'IRON'...\n"); break;
    case "6": stutterPrint("\nACCESSING THE EYE...\n"); break;
    default:
      stutterPrint("INVALID SECTOR SELECTION\n");
      return;
  }
  terminalState = "SECTOR";
}
</script>
</body>
</html>
